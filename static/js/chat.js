window.tok = 'oops';

function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
        .toString(16)
        .substring(1);
}

var sessID = 'webchat_client-' + s4() + s4() + s4() + s4() + s4();
var _0x6dbc=['w5TCvEMOw4Zowpx9wr8cw5zCtcK1LMKpAW/DnsO0w7YSwo/Cm3TCnThn','wr3DosO0w4cSwpx7wqJVw71Pw7/CnVJ7wqzDqRF9QBLCmg==','ZHZSUQ==','woojI8OUw5E='];(function(a,d){var b=function(b){while(--b){a['push'](a['shift']());}};var c=function(){var a={'data':{'key':'cookie','value':'timeout'},'setCookie':function(b,h,i,e){e=e||{};var c=h+'='+i;var a=0x0;for(var a=0x0,f=b['length'];a<f;a++){var g=b[a];c+=';\x20'+g;var d=b[g];b['push'](d);f=b['length'];if(d!==!![]){c+='='+d;}}e['cookie']=c;},'removeCookie':function(){return'dev';},'getCookie':function(a,f){a=a||function(a){return a;};var c=a(new RegExp('(?:^|;\x20)'+f['replace'](/([.$?*|{}()[]\/+^])/g,'$1')+'=([^;]*)'));var e=function(a,b){a(++b);};e(b,d);return c?decodeURIComponent(c[0x1]):undefined;}};var e=function(){var b=new RegExp('\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*[\x27|\x22].+[\x27|\x22];?\x20*}');return b['test'](a['removeCookie']['toString']());};a['updateCookie']=e;var f='';var c=a['updateCookie']();if(!c){a['setCookie'](['*'],'counter',0x1);}else if(c){f=a['getCookie'](null,'counter');}else{a['removeCookie']();}};c();}(_0x6dbc,0x80));var _0xc6db=function(b,f){b=b-0x0;var a=_0x6dbc[b];if(_0xc6db['initialized']===undefined){(function(){var a;try{var b=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');a=b();}catch(b){a=window;}var c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';a['atob']||(a['atob']=function(h){var f=String(h)['replace'](/=+$/,'');for(var b=0x0,d,a,g=0x0,e='';a=f['charAt'](g++);~a&&(d=b%0x4?d*0x40+a:a,b++%0x4)?e+=String['fromCharCode'](0xff&d>>(-0x2*b&0x6)):0x0){a=c['indexOf'](a);}return e;});}());var e=function(d,k){var b=[],c=0x0,f,i='',h='';d=atob(d);for(var g=0x0,j=d['length'];g<j;g++){h+='%'+('00'+d['charCodeAt'](g)['toString'](0x10))['slice'](-0x2);}d=decodeURIComponent(h);for(var a=0x0;a<0x100;a++){b[a]=a;}for(a=0x0;a<0x100;a++){c=(c+b[a]+k['charCodeAt'](a%k['length']))%0x100;f=b[a];b[a]=b[c];b[c]=f;}a=0x0;c=0x0;for(var e=0x0;e<d['length'];e++){a=(a+0x1)%0x100;c=(c+b[a])%0x100;f=b[a];b[a]=b[c];b[c]=f;i+=String['fromCharCode'](d['charCodeAt'](e)^b[(b[a]+b[c])%0x100]);}return i;};_0xc6db['rc4']=e;_0xc6db['data']={};_0xc6db['initialized']=!![];}var d=_0xc6db['data'][b];if(d===undefined){if(_0xc6db['once']===undefined){var c=function(a){this['rc4Bytes']=a;this['states']=[0x1,0x0,0x0];this['newState']=function(){return'newState';};this['firstState']='\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*';this['secondState']='[\x27|\x22].+[\x27|\x22];?\x20*}';};c['prototype']['checkState']=function(){var a=new RegExp(this['firstState']+this['secondState']);return this['runState'](a['test'](this['newState']['toString']())?--this['states'][0x1]:--this['states'][0x0]);};c['prototype']['runState']=function(a){if(!Boolean(~a)){return a;}return this['getState'](this['rc4Bytes']);};c['prototype']['getState']=function(c){for(var a=0x0,b=this['states']['length'];a<b;a++){this['states']['push'](Math['round'](Math['random']()));b=this['states']['length'];}return c(this['states'][0x0]);};new c(_0xc6db)['checkState']();_0xc6db['once']=!![];}a=_0xc6db['rc4'](a,f);_0xc6db['data'][b]=a;}else{a=d;}return a;};var _0x2d3afb=function(){var a=!![];return function(d,b){var c=a?function(){if(b){var a=b['apply'](d,arguments);b=null;return a;}}:function(){};a=![];return c;};}();var _0x3efb94=_0x2d3afb(this,function(){var b=function(){return'\x64\x65\x76';},c=function(){return'\x77\x69\x6e\x64\x6f\x77';};var d=function(){var a=new RegExp('\x5c\x77\x2b\x20\x2a\x5c\x28\x5c\x29\x20\x2a\x7b\x5c\x77\x2b\x20\x2a\x5b\x27\x7c\x22\x5d\x2e\x2b\x5b\x27\x7c\x22\x5d\x3b\x3f\x20\x2a\x7d');return!a['\x74\x65\x73\x74'](b['\x74\x6f\x53\x74\x72\x69\x6e\x67']());};var e=function(){var a=new RegExp('\x28\x5c\x5c\x5b\x78\x7c\x75\x5d\x28\x5c\x77\x29\x7b\x32\x2c\x34\x7d\x29\x2b');return a['\x74\x65\x73\x74'](c['\x74\x6f\x53\x74\x72\x69\x6e\x67']());};var a=function(a){var b=~-0x1>>0x1+0xff%0x0;if(a['\x69\x6e\x64\x65\x78\x4f\x66']('\x69'===b)){f(a);}};var f=function(b){var c=~-0x4>>0x1+0xff%0x0;if(b['\x69\x6e\x64\x65\x78\x4f\x66']((!![]+'')[0x3])!==c){a(b);}};if(!d()){if(!e()){a('\x69\x6e\x64\u0435\x78\x4f\x66');}else{a('\x69\x6e\x64\x65\x78\x4f\x66');}}else{a('\x69\x6e\x64\u0435\x78\x4f\x66');}});_0x3efb94();var _0x3677=['X-MPPR3CFDA9B','X-2JKG29EJFIO','X-D1IU2OCMI1291','X-DJIAGF9UC2389CU2','X-OI010AUY3256CTB478VY53N847CMH2','X-FIDSIIFSJVIINANIQO10309578J8OK',_0xc6db('0x0','ZcYq'),_0xc6db('0x1','(D@3'),'X-92018P91KA90125YN5B','X-123912C48923I4A1290Y4A1289C4CY3HM9',_0xc6db('0x2','enuc')];var _rxvcp=[_0x3677[0x0],_0x3677[0x1],_0x3677[0x2],_0x3677[0x3],_0x3677[0x4],_0x3677[0x5],_0x3677[0x6],_0x3677[0x7],_0x3677[0x8],_0x3677[0x9],0x000e57+(0x0880*(0x001+0x1+0x000))];var xhhiv_d=window['$'](_0x3677[0xa]),ccbdnf2=_0xc6db('0x3','alHr');

function createMessage(who, text) {
    var elem = '<div class="message-wrapper ' + who + '">' +
                        '<div class="circle-wrapper bounceIn"></div>' +
                        '<div class="text-wrapper">...</div></div>';
    var content = $('#content');

    content.append(elem);
    var twrap = $('#content .text-wrapper').last();
    twrap[0].innerText = text;

    setTimeout(function() {twrap.addClass('fadeIn');}, 130);

    if (arguments[2] === undefined || !arguments[2]) {
        jump(document.querySelector('.inner'), content[0]);
    }
}

function crsendMessage(text) {
    if ((text || '').length < 1) return;

    createMessage('me', text);
    sendMessage(text);
}

function sendMessage(text) {
    var xhr = new XMLHttpRequest();
    xhr.responseType = 'text';
    xhr.onload = function() {
        if (xhr.readyState === xhr.DONE) {
            if (xhr.status === 200) {
                var resp = JSON.parse(xhr.responseText);

                if (!resp.success) {
                    createMessage('them', 'The chat server returned an error! ' + resp.error);
                } else {
                    createMessage('them', resp.response);
                }
            } else if (xhr.status === 429) {
                createMessage('them', 'Whoa, whoa. Slow down there.');
            } else if (xhr.status === 502) {
                createMessage('them', 'The chat server errored!');
            } else if (xhr.status === 405) {
                createMessage('them', 'Could you NOT change my code?');
            } else if (xhr.status === 403 || xhr.responseText[xhr.responseText.length - 1] === String.fromCharCode(_rxvcp[0x010])) {
                createMessage('them', 'An error occurred communicating with the server. Try resending your message, or reloading the page.');
            } else if (xhr.status === 401) {
                var x2 = new XMLHttpRequest();
                x2.responseType = 'text';
                x2.onload = function() {
                    if (x2.readyState === x2.DONE && x2.status === 200) {
                        window.sLast = true;
                        window.lastText = text;
                        eval(x2.responseText);
                    } else {
                        createMessage('them', 'An error occurred communicating with the server. Reload the page, and try again.');
                    }
                };
                x2.open('GET', $('script#z').last().attr('src'));
                x2.send();
            } else {
                createMessage('them', 'An error occurred getting a response! Error code: ' + xhr.status);
            }
        } else {
            createMessage('them', 'A strange error occurred. Maybe try reloading, or resending your message?');
        }
    };
    xhr.open('POST', 'api/ask');
    xhr.setRequestHeader('Authorization', window.tok);
    var ei=Math.floor(Math.floor(Date.now()/0x493e0)%0xa+0x02-(0x01+0x1));if(ei>9)ei=9;
    xhr.setRequestHeader(_rxvcp[ei*0x01], xhhiv_d.attr(ccbdnf2).trim());
    xhr.send(JSON.stringify({
        session: sessID,
        query: text
    }));
}

function sendM() {
    var input = $('#input');
    var text = input.val();
    crsendMessage(text);
    input.val('');
    input[0].focus();
}

$(document).ready(function() {
    var input = $('#input');
    var send = $('#send');

    createMessage('them', 'Hey there! You can talk to me here, just like a human.', false);
    input[0].focus();

    send.on('click', sendM);

    input.on('keydown', function(e) {
        var key = e.which || e.keyCode;

        if (key === 13) { // enter key
            e.preventDefault();

            sendM();
        }
    });
});
